# -*- coding: utf-8 -*-

"""
–£—Ç–∏–ª–∏—Ç—ã –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –≤–≤–æ–¥–∞.
"""

import re
from telebot.types import Message
from config import bot, user_state
from utils import clear_state, main_menu_keyboard, easy_level_keyboard, medium_level_keyboard, hard_level_keyboard

# –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –≤–æ–∑–º–æ–∂–Ω—ã—Ö –∫–æ–º–∞–Ω–¥ –±–æ—Ç–∞
MENU_COMMANDS = [
    # –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
    "‚ûï –î–æ–¥–∞—Ç–∏ –Ω–æ–≤–µ —Å–ª–æ–≤–æ", "üü¢ –õ–µ–≥–∫–∏–π —Ä—ñ–≤–µ–Ω—å", "üü† –°–µ—Ä–µ–¥–Ω—ñ–π —Ä—ñ–≤–µ–Ω—å", 
    "üî¥ –°–∫–ª–∞–¥–Ω–∏–π —Ä—ñ–≤–µ–Ω—å", "üë§ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∏–π —Å–ª–æ–≤–Ω–∏–∫", "üë• –°–ø—ñ–ª—å–Ω–∏–π —Å–ª–æ–≤–Ω–∏–∫",
    
    # –õ–µ–≥–∫–∏–π —É—Ä–æ–≤–µ–Ω—å
    "üìñ –í—á–∏—Ç–∏ –Ω–æ–≤—ñ —Å–ª–æ–≤–∞", "üîÑ –ü–æ–≤—Ç–æ—Ä–∏—Ç–∏", "üè∑Ô∏è –í–∏–≤—á–∞—Ç–∏ –∞—Ä—Ç–∏–∫–ª—ñ", 
    "üß© –í–∏–≤—á–∞—Ç–∏ –ø—Ä–∏—Å–≤—ñ–π–Ω—ñ –∑–∞–π–º–µ–Ω–Ω–∏–∫–∏",
    
    # –°—Ä–µ–¥–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å
    "üî§ –í–∏–±—ñ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –Ω–∞–ø–∏—Å–∞–Ω–Ω—è", "üìù –ó–∞–ø–æ–≤–Ω—ñ—Ç—å –ø—Ä–æ–ø—É—Å–∫–∏",
    "üß© –í–∏–≤—á–∞—Ç–∏ –ø—Ä–∏—Å–≤—ñ–π–Ω—ñ –∑–∞–π–º–µ–Ω–Ω–∏–∫–∏ (—Å–µ—Ä–µ–¥–Ω—ñ–π)",
    
    # –°–ª–æ–∂–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å
    "üß© –°–∫–ª–∞–¥–Ω–∞ –≥—Ä–∞", "üìù –í–≤–µ–¥–µ–Ω–Ω—è —Å–ª—ñ–≤", "üè∑Ô∏è –í–≤–µ–¥–µ–Ω–Ω—è –∞—Ä—Ç–∏–∫–ª—ñ–≤",
    "üß© –í–∏–≤—á–∞—Ç–∏ –ø—Ä–∏—Å–≤—ñ–π–Ω—ñ –∑–∞–π–º–µ–Ω–Ω–∏–∫–∏ (—Å–∫–ª–∞–¥–Ω–∏–π)",
    
    # –û–±—â–∏–µ –∫–æ–º–∞–Ω–¥—ã
    "‚Ü©Ô∏è –ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –¥–æ –≥–æ–ª–æ–≤–Ω–æ–≥–æ –º–µ–Ω—é", "‚úñÔ∏è –í—ñ–¥–º—ñ–Ω–∞",
    
    # –ö–æ–º–∞–Ω–¥—ã —Å–ª–æ–≤–∞—Ä–µ–π
    "üÜï –°—Ç–≤–æ—Ä–∏—Ç–∏ —Å–ø—ñ–ª—å–Ω–∏–π —Å–ª–æ–≤–Ω–∏–∫", "üîë –í—Å—Ç—É–ø–∏—Ç–∏ –¥–æ —Å–ø—ñ–ª—å–Ω–æ–≥–æ —Å–ª–æ–≤–Ω–∏–∫–∞",
    "üìã –ú–æ—ó —Å–ø—ñ–ª—å–Ω—ñ —Å–ª–æ–≤–Ω–∏–∫–∏"
]

def is_menu_command(text):
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—Å—Ç –∫–æ–º–∞–Ω–¥–æ–π –º–µ–Ω—é"""
    return text in MENU_COMMANDS

def safe_next_step_handler(message, handler_func, allowed_commands=None):
    """
    –ë–µ–∑–æ–ø–∞—Å–Ω–æ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–ª–µ–¥—É—é—â–µ–≥–æ —à–∞–≥–∞, —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç –∫–æ–º–∞–Ω–¥ –º–µ–Ω—é.
    
    Args:
        message: –°–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç–∞, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–µ –æ–∂–∏–¥–∞–µ—Ç—Å—è –æ—Ç–≤–µ—Ç
        handler_func: –§—É–Ω–∫—Ü–∏—è-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ–±—ã—á–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        allowed_commands: –°–ø–∏—Å–æ–∫ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö –∫–æ–º–∞–Ω–¥ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    """
    if allowed_commands is None:
        allowed_commands = []
    
    def wrapper(message):
        chat_id = message.chat.id
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥–æ–π –º–µ–Ω—é
        if message.text in MENU_COMMANDS and message.text not in allowed_commands:
            # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤—ã—Ö–æ–¥ –∏–∑ —Ç–µ–∫—É—â–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
            handle_exit_from_activity(message)
            return
        
        # –í—ã–∑—ã–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
        handler_func(message)
    
    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±–µ—Ä—Ç–∫—É –∫–∞–∫ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
    bot.register_next_step_handler(message, wrapper)

def handle_exit_from_activity(message):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—ã—Ö–æ–¥ –∏–∑ –ª—é–±–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ –∫–æ–º–∞–Ω–¥–µ –º–µ–Ω—é"""
    chat_id = message.chat.id
    command = message.text
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —É—Ä–æ–≤–Ω–µ
    preserve_level = command in ["üß© –°–∫–ª–∞–¥–Ω–∞ –≥—Ä–∞", "üìù –í–≤–µ–¥–µ–Ω–Ω—è —Å–ª—ñ–≤", "üè∑Ô∏è –í–≤–µ–¥–µ–Ω–Ω—è –∞—Ä—Ç–∏–∫–ª—ñ–≤",
                                "üî§ –í–∏–±—ñ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –Ω–∞–ø–∏—Å–∞–Ω–Ω—è", "üìù –ó–∞–ø–æ–≤–Ω—ñ—Ç—å –ø—Ä–æ–ø—É—Å–∫–∏",
                                "üìñ –í—á–∏—Ç–∏ –Ω–æ–≤—ñ —Å–ª–æ–≤–∞", "üîÑ –ü–æ–≤—Ç–æ—Ä–∏—Ç–∏", "üè∑Ô∏è –í–∏–≤—á–∞—Ç–∏ –∞—Ä—Ç–∏–∫–ª—ñ", 
                                "üß© –í–∏–≤—á–∞—Ç–∏ –ø—Ä–∏—Å–≤—ñ–π–Ω—ñ –∑–∞–π–º–µ–Ω–Ω–∏–∫–∏", "üß© –í–∏–≤—á–∞—Ç–∏ –ø—Ä–∏—Å–≤—ñ–π–Ω—ñ –∑–∞–π–º–µ–Ω–Ω–∏–∫–∏ (—Å–µ—Ä–µ–¥–Ω—ñ–π)",
                                "üß© –í–∏–≤—á–∞—Ç–∏ –ø—Ä–∏—Å–≤—ñ–π–Ω—ñ –∑–∞–π–º–µ–Ω–Ω–∏–∫–∏ (—Å–∫–ª–∞–¥–Ω–∏–π)"]
    
    # –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ, —Å–æ—Ö—Ä–∞–Ω—è—è —Ç–∏–ø —Å–ª–æ–≤–∞—Ä—è –∏ –≤–æ–∑–º–æ–∂–Ω–æ —É—Ä–æ–≤–µ–Ω—å
    clear_state(chat_id, preserve_dict_type=True, preserve_messages=False, preserve_level=preserve_level)
    
    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–æ–º–∞–Ω–¥—É
    if command == "‚Ü©Ô∏è –ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –¥–æ –≥–æ–ª–æ–≤–Ω–æ–≥–æ –º–µ–Ω—é":
        bot.send_message(chat_id, "–ì–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é:", reply_markup=main_menu_keyboard(chat_id))
    elif command == "üü¢ –õ–µ–≥–∫–∏–π —Ä—ñ–≤–µ–Ω—å":
        bot.send_message(chat_id, "üü¢ –õ–µ–≥–∫–∏–π —Ä—ñ–≤–µ–Ω—å - –æ–±–µ—Ä—ñ—Ç—å –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å:", reply_markup=easy_level_keyboard())
    elif command == "üü† –°–µ—Ä–µ–¥–Ω—ñ–π —Ä—ñ–≤–µ–Ω—å":
        bot.send_message(chat_id, "üü† –°–µ—Ä–µ–¥–Ω—ñ–π —Ä—ñ–≤–µ–Ω—å - –æ–±–µ—Ä—ñ—Ç—å –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å:", reply_markup=medium_level_keyboard())
    elif command == "üî¥ –°–∫–ª–∞–¥–Ω–∏–π —Ä—ñ–≤–µ–Ω—å":
        bot.send_message(chat_id, "üî¥ –°–∫–ª–∞–¥–Ω–∏–π —Ä—ñ–≤–µ–Ω—å - –æ–±–µ—Ä—ñ—Ç—å –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å:", reply_markup=hard_level_keyboard())
    else:
        # –ü–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏
        from telebot.types import Message
        new_message = Message(
            message_id=message.message_id,
            from_user=message.from_user,
            date=message.date,
            chat=message.chat,
            content_type='text',
            options={},
            json_string=None
        )
        new_message.text = message.text
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –∫–æ–º–∞–Ω–¥—ã
        bot.process_new_messages([new_message])

def sanitize_user_input(text, max_length=100):
    """
    –û—á–∏—â–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –≤–≤–æ–¥ –æ—Ç –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –æ–ø–∞—Å–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤.
    
    Args:
        text: –¢–µ–∫—Å—Ç –¥–ª—è –æ—á–∏—Å—Ç–∫–∏
        max_length: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ —Ç–µ–∫—Å—Ç–∞
    
    Returns:
        –û—á–∏—â–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
    """
    if not text:
        return ""
    
    # –£–¥–∞–ª—è–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã, –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ –ø—Ä–æ—Å—Ç—É—é –ø—É–Ω–∫—Ç—É–∞—Ü–∏—é
    text = re.sub(r'[^\w\s\.\,\-\(\)\/]', '', text)
    
    # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É
    return text[:max_length]
